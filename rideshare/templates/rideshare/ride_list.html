{% extends "base.html" %}
{% load staticfiles %}

{% block content %}{{ block.super }}

<div class="col-sm-12" style="margin-top: 1em">

{% if not user.is_authenticated %}
 <a class="pull-right btn btn-primary" style="margin-left: .5em;" href="{{ login_url }}">
	<i class="fa fa-power-off"></i> Connexion
	</a>
{% endif %}

 <a class="pull-right btn btn-secondary" style="margin-left: .5em;" href="{% url 'create_new_ride' event.slug %}">
	<i class="fa fa-plus"></i> Proposer un nouveau trajet
	</a> 

 <a class="pull-right btn btn-secondary" href="mailto:evenements@jeunes-democrates.org?subject=Problème sur le site de coivoiturage">
	<i class="fa fa-question"></i> Aide<!-- TODO : make it better help -->
	</a>


<h1 class="page-title">{{ event.name }}</h1>

{% if owned_rides or joined_rides or active_requests %}
	<hr class="clearfix" />
	<a id="all_rides_filter" class="btn btn-secondary ride-filter active">Tous</a>
{% endif %}

{% if owned_rides %}
	<a id="owned_rides_filter" class="btn btn-secondary ride-filter">Mes offres de trajets</a>
{% endif %}

{% if joined_rides %}
	<a id="joined_rides_filter" class="btn btn-secondary ride-filter">Les trajets auxquels je suis inscrit</a>
{% endif %}

{% if active_requests %}
	<a id="active_requests_filter" class="btn btn-secondary ride-filter">Trajets en cours de souscription</a>
{% endif %}

<div id="region-filters"><hr class="clearfix" /></div>
<div id="return-filters"><hr class="clearfix" />
	<a id="return-all" class="btn btn-secondary return-filter active">Tous</a>
	<a id="return-go" class="btn btn-secondary return-filter">Allers</a>
	<a id="return-return" class="btn btn-secondary return-filter">Retours</a>
</div>

<hr class="clearfix" />

<div id="all_rides_container" class="ride-container">

	{% for object in object_list %}
	
	<div class="ride card"
		data-user-is-owner={% if object.owner == user %}"true"{% else %}"false"{% endif %}
		data-user-is-participant={% if user in object.riders.all %}"true"{% else %}"false"{% endif %}
		data-region="{{ object.stop_set.all.0.location.region }}"
		data-return="{{ object.is_return }}"
		data-status="{% for rider in object.rider_set.all %}{% if rider.user == user %}{{ rider.status }}{% endif %}{% endfor %}"
		>	


		<div class="card-header">
			<span class="ride__remaining-seats">
				{% if object.rider__count == object.seats %}
				<span class="text-muted">Complet</span>
				{% else %}
				Places disponibles : <strong>{{ object.remaining_seats }}</strong> / {{ object.seats }}
				{% endif %}
			</span>
			Départ le <strong>{{ object.departure_datetime|date:"l d F" }}</strong>
			{% if object.departure_date|date != object.arrival_date|date %}
			, arrivée le <strong>{{ object.arrival_datetime|date:"l d F" }}, </strong>
			{% endif %}
			avec {{ object.owner.first_name }} {{ object.owner.last_name }}
		</div>
	
		<div class="card-block">
			<div class="ride__stops">
			{% for stop in object.stop_set.all %}
				<div class="ride__stop">
					<span class="ride__stop__pin"><i class="fa fa-dot-circle-o"></i> </span>
					<span class="ride__stop__time">{{ stop.time|time:"H:i" }}</span>
					<span class="ride__stop__location">{{ stop.location.locality }}</span>
				</div>
			{% endfor %}
			</div>
			<div class="ride__interactions">
				<div class="ride__price">{{ object.price }} €</div>
				{% if object.rider__count >= object.seats %}
				<span class="ride__join btn btn-secondary btn-disabled">Complet</span>
				{% else %}
				<a class="ride__join btn btn-secondary" data-url="{% url 'request_to_join_ride' object.pk %}" href="#join"> 
				{% endif %}
				</a>
			</div>
		</div>
	
	</div>

{% endfor %}

</div>

{% if not object_list %}
<p>Il n'y a pas encore de trajets sur cet évènement.</p>
{% endif %}

</div>

<style>

.page-title { display: inline; }

.ride__remaining-seats { float: right; margin-left: 1em; }

.ride__stops { display: table; float: left; }
.ride__stop { display: table-row; }
.ride__stop > span { display: table-cell; padding: 0 1em; }

.ride__interactions { float: right; }
.ride__price { font-size: 1.6em; text-align: right; margin-bottom: .25em; }

.ride-container.return-go [data-return="False"] { display: none; }
.ride-container.return-return [data-return="True"] { display: none; }

.ride__join { margin-left: 1em; }

</style>

{% endblock content %}



{% block scripts %} {{ block.super }}

<script>

$( document ).ready(function() {

	function $call(url) {
		$.ajax({url: url})
	}
	
	function displayLoadingState($element) {
		$element.html('<i class="fa fa-circle-o-notch fa-spin fa-fw"></i> Chargement...')
	}
	
	$('.ride__join').click(function(){
		var $this = $(this)
			request_join_url = $this.attr('data-url')
		displayLoadingState($this)
		$.ajax({url: request_join_url}).done(function(result) {
			$this.removeClass('btn-success btn-error')
			if (result.requestSuccessful) {
				$this.addClass('btn-success')
				$this.html("<i class='fa fa-check'></i> C'est tout bon !")
			} else {
				$this.addClass('btn-error')
				$this.html("<i class='fa fa-check'></i> Ça n'a pas marché :(")
	
			}
		})
	})
	
	$('.ride-filter').click(function(){
		$('.ride-filter').removeClass('active')
		$(this).addClass('active')
		$('.ride-container').hide()
		var containerName = $(this).attr('id').replace('_filter', '_container')
		$('#' + containerName).show()
	})
	
	
	
	window.rideshareStore = {
		'regions': [],
	}
	
	$('#all_rides_container .ride').each(function(){
		rideshareStore.regions.push($(this).data('region'))
	})
	
	
	if (rideshareStore.regions) {
		rideshareStore.regions = $.uniqueSort(rideshareStore.regions).sort()
		$('#region-filters').append(
			'<button id="all-regions" data-region="all" class="btn btn-secondary active region-filter">Toute la France</button> '
		)
		$.each($.uniqueSort(rideshareStore.regions), function(i, region) {
			$('#region-filters').append(
				'<button data-region="' + region + '" class="btn btn-secondary region-filter">' + region + '</button> '
			)
		})
	}
	
	$('.region-filter').click(function(){
		var region = $(this).data('region')
		$('.region-filter').removeClass('active')
		$(this).addClass('active')
		$('.ride').hide()
		if (region=="all") {
			$('.ride').show()
		} else {
			console.log('filtering for region ' + region)
			$('.ride[data-region="' + region + '"').show()
		}
	})

	$('.return-filter').click(function(){
		$('.return-filter').removeClass('active')
		$(this).addClass('active')
		$('.ride-container').removeClass('return-all return-go return-return')
		$('.ride-container').addClass($(this).attr('id'))
	})

	$('.ride__join').each(function(){
		var $button = $(this)
			$ride = $button.closest('.ride')
		if ($ride.data('status') == 'CONFIRMED') {
			$button.html('<i class="fa fa-times"></i> Annuler')
			$button.before('<span class="text-success">Vous avez une place à bord de ce trajet.</span>')
		} else {
			$button.html('<i class="fa fa-sign-in"></i> Demander à rejoindre')
		}


	})

})

</script>

{% endblock scripts %}