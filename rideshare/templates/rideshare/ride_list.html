{% extends "base.html" %}
{% load staticfiles %}

{% block content %}{{ block.super }}

<div class="col-sm-12" style="margin-top: 1em">

<!-- HEADER -->

<h1 class="page-title">{{ event.name }}</h1>

<div class="pull-right buttons clearfix">

	{% if not user.is_authenticated %}
	 <a class="btn btn-primary" href="{{ login_url }}">
		<i class="fa fa-power-off"></i> Connexion
		</a>
	{% endif %}
	
	 <a class="btn btn-secondary" href="{% url 'rideshare_ride_create' event.slug %}">
		<i class="fa fa-plus"></i> Proposer un nouveau trajet
		</a> 
	
	 <a class="btn btn-secondary" href="mailto:evenements@jeunes-democrates.org?subject=Problème sur le site de coivoiturage">
		<i class="fa fa-question"></i> Aide<!-- TODO : make it better help -->
		</a>
	
</div>

<div style="clear: both;"></div>

<!-- FILTERS -->

<hr class="clearfix" />
<div id="ownership-filters" class="buttons">
	<button type="button" data-filter-ownership="" class="btn btn-sm btn-outline-primary ownership-filter active">Tous</button>
	<button type="button" data-filter-ownership="user-is-owner" class="btn btn-sm btn-outline-primary ownership-filter">Mes offres</button>
	<button type="button" data-filter-ownership="user-is-participant" class="btn btn-sm btn-outline-primary ownership-filter">Mes voyages</button>
</div>

<hr class="clearfix" />
<div id="return-filters" class="buttons">
	<button type="button" data-filter-return="" class="btn btn-sm btn-outline-primary return-filter active">Tous</button>
	<button type="button" data-filter-return="aller" class="btn btn-sm btn-outline-primary return-filter">Allers</button>
	<button type="button" data-filter-return="retour" class="btn btn-sm btn-outline-primary return-filter">Retours</button>
</div>

<hr class="clearfix" />
<div id="region-filters" class="buttons">
	<!-- JS Generated -->
</div>

<hr class="clearfix" />

<div class="ride-container">

	{% for object in object_list %}
	
	<div class="ride card"
		data-user-is-owner={% if object.owner == user %}"true"{% else %}"false"{% endif %}
		data-user-is-participant={% if user in object.riders.all %}"true"{% else %}"false"{% endif %}
		data-region="{% if object.is_return %}{{ object.stop_set.all.reverse.0.location.region }}{% else %}{{ object.stop_set.all.0.location.region }}{% endif %}"
		data-return="{% if object.is_return %}retour{% else %}aller{% endif %}"
		data-status="{% for rider in object.rider_set.all %}{% if rider.user == user %}{{ rider.status }}{% endif %}{% endfor %}"
		>	


		<div class="card-header">
			<span class="ride__remaining-seats">
				{% if object.rider__count == object.seats %}
				<span class="text-muted">Complet</span>
				{% else %}
				Places disponibles : <strong>{{ object.remaining_seats }}</strong> / {{ object.seats }}
				{% endif %}
			</span>
			Départ le <strong>{{ object.departure_datetime|date:"l d F" }}</strong>
			{% if object.departure_date|date != object.arrival_date|date %}
			, arrivée le <strong>{{ object.arrival_datetime|date:"l d F" }}, </strong>
			{% endif %}
			avec {{ object.owner.first_name }} {{ object.owner.last_name }}
		</div>
	
		<div class="card-block">
			<div class="ride__stops">
			{% for stop in object.stop_set.all %}
				<div class="ride__stop">
					<span class="ride__stop__pin"><i class="fa fa-dot-circle-o"></i> </span>
					<span class="ride__stop__time">{{ stop.time|time:"H:i" }}</span>
					<span class="ride__stop__location">{{ stop.location.locality }}</span>
				</div>
			{% endfor %}
			</div>
			<div class="ride__interactions">
				<div class="ride__price">{{ object.price }} €</div>
				{% if object.rider__count >= object.seats %}
				<span class="ride__join btn btn-outline-primary btn-disabled">Complet</span>
				{% else %}
				<a class="ride__join btn btn-outline-primary" href="{% url 'rideshare_ride_detail' object.pk %}">
					<i class="fa fa-search"></i> 
					Consulter
				</a>
				{% endif %}
			</div>
		</div>
	
	</div>

{% endfor %}

</div>

<div class="alert alert-warning no-rides-alert" style="display: none;">
	<i class="fa fa-exclamation-circle"></i>&nbsp; Il n'y a aucun trajet correspondant à cette recherche.
</div>


{% if not object_list %}
<p>Il n'y a pas encore de trajets sur cet évènement.</p>
{% endif %}

</div>

<style>

.page-title { display: inline; }

.ride__remaining-seats { float: right; margin-left: 1em; }

.ride__stops { display: table; float: left; }
.ride__stop { display: table-row; }
.ride__stop > span { display: table-cell; padding: 0 1em; }

.ride__interactions { float: right; }
.ride__price { font-size: 1.6em; text-align: right; margin-bottom: .25em; }

.ride__join { margin-left: 1em; }

.buttons { line-height: 2; }

</style>

{% endblock content %}



{% block scripts %} {{ block.super }}

<script>

$( document ).ready(function() {

	function $call(url) {
		$.ajax({url: url})
	}
	
	function displayLoadingState($element) {
		$element.html('<i class="fa fa-circle-o-notch fa-spin fa-fw"></i> Chargement...')
	}
	
	window.rideshareStore = {
		'regions': [],
		'filters': {
			'user-is-owner': '',
			'user-is-participant': '',
			'region': '',
			'return': '',
			'status': '',
		}
	}
	
	$('.ride').each(function(){
		rideshareStore.regions.push($(this).data('region'))
	})
	
	
	if (rideshareStore.regions) {
		rideshareStore.regions = $.uniqueSort(rideshareStore.regions).sort()
		$('#region-filters').append(
			'<button type="button" data-filter-region="" class="btn btn-sm btn-outline-primary active region-filter">Toute la France</button> '
		)
		$.each($.uniqueSort(rideshareStore.regions), function(i, region) {
			$('#region-filters').append(
				'<button type="button" data-filter-region="' + region + '" class="btn btn-sm btn-outline-primary region-filter">' + region + '</button> '
			)
		})
	}
	
	$('.region-filter').click(function(){
		$('.region-filter').removeClass('active')
		$(this).addClass('active')
		rideshareStore.filters.region = $(this).data('filter-region')
		filterRides()
	})

	$('.return-filter').click(function(){
		$('.return-filter').removeClass('active')
		$(this).addClass('active')
		rideshareStore.filters.return = $(this).data('filter-return')
		filterRides()
	})

	$('.ownership-filter').click(function(){
		$('.ownership-filter').removeClass('active')
		$(this).addClass('active')
		rideshareStore.filters['user-is-owner'] = ""
		rideshareStore.filters['user-is-participant'] = ""
		rideshareStore.filters[$(this).data('filter-ownership')] = true
		filterRides()
	})
	
	function filterRides() {
		$('.ride').hide() // Hide all rides
		$('.no-rides-alert').hide()
		var selectors = ''
			filters = rideshareStore.filters
		if (filters['user-is-owner']) selectors += '[data-user-is-owner="true"]'
		if (filters['user-is-participant']) selectors += '[data-user-is-participant="true"]'
		if (filters['region'] != '') selectors += '[data-region="' + filters['region'] + '"]'
		if (filters['return'] != '') selectors += '[data-return="' + filters['return'] + '"]'
		var rides = $('.ride' + selectors)
		if (rides.length==0) { // if there are no rides, show alert 
			$('.no-rides-alert').fadeIn()
		} else { // otherwise, show the filtered rides
			$('.ride' + selectors).fadeIn()
		}

	}

})

</script>

{% endblock scripts %}